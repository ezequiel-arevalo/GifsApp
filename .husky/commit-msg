COMMIT_MSG_FILE=$1
COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

echo "üìù Validando mensaje de commit..."

# --------------------------------------
# 1) Verificar que el commit no est√© vac√≠o
# --------------------------------------
if [ -z "$COMMIT_MSG" ] || [ "$COMMIT_MSG" = "" ]; then
  echo "‚ùå El mensaje de commit est√° vac√≠o."
  echo "   Por favor escrib√≠ un mensaje descriptivo."
  exit 1
fi

# --------------------------------------
# 2) Bloquear commits gen√©ricos o basura
# --------------------------------------
BAD_COMMIT_REGEX="^(wip|temp|test|update|changes|fixing|asdf|qwe)$"

if echo "$COMMIT_MSG" | grep -Eiq "$BAD_COMMIT_REGEX"; then
  echo "‚ùå El mensaje de commit es demasiado gen√©rico:"
  echo "   '$COMMIT_MSG'"
  echo ""
  echo "Us√° un mensaje m√°s descriptivo siguiendo la convenci√≥n."
  exit 1
fi

# --------------------------------------
# 3) Confirmar que el tipo del commit existe
#    (feat, fix, docs, refactor, chore, etc.)
# --------------------------------------
VALID_TYPES="(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)"

if ! echo "$COMMIT_MSG" | grep -Eiq "^$VALID_TYPES"; then
  echo "‚ùå El commit debe comenzar con un tipo v√°lido."
  echo "   Ejemplo: feat: agregar login"
  exit 1
fi

# --------------------------------------
# 4) Validar usando commitlint
# --------------------------------------
echo "üîç Ejecutando commitlint..."

npx commitlint --edit "$COMMIT_MSG_FILE"
RESULT=$?

if [ $RESULT -ne 0 ]; then
  echo "‚ùå commitlint detect√≥ errores en el mensaje."
  exit 1
fi

# --------------------------------------
# 5) Validaci√≥n final
# --------------------------------------
echo "‚úÖ Commit v√°lido ‚Äî todo listo!"
exit 0
