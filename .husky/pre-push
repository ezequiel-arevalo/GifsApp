echo "ğŸ” Iniciando controles previos al push..."

# -----------------------------
# 1) Obtener rama actual
# -----------------------------
CURRENT_BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null)

if [ -z "$CURRENT_BRANCH" ]; then
  echo "âš ï¸  No se pudo determinar la rama actual."
  exit 1
fi

echo "ğŸŒ¿ Rama detectada: $CURRENT_BRANCH"

# -----------------------------
# 2) Excepciones para ramas principales
# -----------------------------
if [ "$CURRENT_BRANCH" = "main" ] || [ "$CURRENT_BRANCH" = "master" ]; then
  echo "â­ï¸  Saltando validaciones para rama principal."
  exit 0
fi

# -----------------------------
# 3) Bloqueo de palabras genÃ©ricas o basura
# -----------------------------
BLOCKED_WORDS="(wip|temp|test|tmp|draft|demo|asd|qwe|123|abc|backup|copy|new|old|sample)"

if echo "$CURRENT_BRANCH" | grep -E "$BLOCKED_WORDS" >/dev/null; then
  echo "âŒ La rama contiene palabras no permitidas."
  echo "   âœ EvitÃ¡ nombres genÃ©ricos como: wip, temp, test, asd, 123, etc."
  exit 1
fi

# -----------------------------
# 4) Patrones vÃ¡lidos de nombres de rama
# -----------------------------
VALID_PATTERNS="^(
  feature\/[a-z0-9-]+ |
  fix\/[a-z0-9-]+ |
  refactor\/[a-z0-9-]+ |
  docs\/[a-z0-9-]+ |
  chore\/[a-z0-9-]+ |
  release\/[0-9]+\.[0-9]+\.[0-9]+ |
  [A-Z]+-[0-9]+\/[a-z0-9-]+
)$"

if echo "$CURRENT_BRANCH" | grep -Ex "$VALID_PATTERNS" >/dev/null; then
  echo "âœ… Nombre de rama vÃ¡lido."
else
  echo ""
  echo "âŒ Nombre de rama invÃ¡lido: '$CURRENT_BRANCH'"
  echo ""
  echo "Usa uno de estos formatos:"
  echo "  â€¢ feature/nombre-descriptivo"
  echo "  â€¢ fix/arreglar-algo"
  echo "  â€¢ refactor/nombre"
  echo "  â€¢ docs/actualizar-docs"
  echo "  â€¢ chore/mantenimiento"
  echo "  â€¢ release/1.2.3"
  echo "  â€¢ ABC-123/descripcion (para ramas con ticket)"
  echo ""
  exit 1
fi

# -----------------------------
# 5) VerificaciÃ³n de tipos
# -----------------------------
echo "ğŸ§ª Revisando typescript..."
npm run type-check >/dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "âŒ FallÃ³ la verificaciÃ³n de tipos."
  exit 1
fi

# -----------------------------
# 6) Linting con Biome
# -----------------------------
echo "ğŸ§¹ Corriendo Biome..."
npx biome check src >/dev/null
if [ $? -ne 0 ]; then
  echo "âŒ Biome detectÃ³ problemas."
  echo "   EjecutÃ¡: npx biome check --write src"
  exit 1
fi

# -----------------------------
# 7) Build del proyecto
# -----------------------------
echo "ğŸ—ï¸ Compilando proyecto..."
npm run build >/dev/null 2>&1
if [ $? -ne 0 ]; then
  echo "âŒ Error en el build."
  exit 1
fi

echo ""
echo "ğŸ‰ Todo OK â€” Push autorizado!"
